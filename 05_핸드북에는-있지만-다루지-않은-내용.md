## 핸드북에는 있지만, 다루지 않은 내용 정리

<br />

## 소스 맵(Source Map)

소스 맵이란 '배포용으로 빌드한 파일'과 '원본 파일'을 서로 연결 시켜주는 기능이다.<br />
보통 서버에 배포를할 때 최적화를 위해 HTML, CSS, JS와 같은 웹 자원들을 압축한다. 그런데 만약 압축하여 배포한 파일에서 에러가 난다면 어떻게 디버깅을 할 수 있을까?<br />

바로 소스 맵을 이용해 배포용 파일의 특정 부분이 원본 소스의 어떤 부분인지 확인하는 것이다.<br />
이러한 편의성을 제공하는 것이 소스 맵이다.

<br />

### 소스 맵 설정하기

웹팩에서 소스 맵을 설정하는 방법은 다음과 같다.

```js
// webpack.config.js
module.exports = {
  devtool: 'cheap-eval-source-map'
}
```

> `devtool` 속성을 추가하고 소스 맵 설정 옵션 중 하나를 선택해 지정해주면 된다.

<br />

### 소스 맵 설정 옵션

위에서 정의한 소스 맵 설정 옵션 이외에도 많은 옵션들이 있다.<br />
자세한 옵션 속성과 [링크](https://webpack.js.org/configuration/devtool/#devtool)로 확인할 수 있다.

<br />

## HMR(Hot Module Repaclement)

HMR은 브라우저를 새로 고치지 않아도 웹팩으로 빌드한 결과물이 웹 애플리케이션에 실시간으로 반영될 수 있게 도와주는 설정이다.<br />
브라우저 새로고침을 위한 LiveReload 대신에 사용할 수 있으며, 웹팩 데브 서버아 함께 사용할 수도 있다.

<br />

### HMR 설정하기

리액트, 앵귤러, 뷰와 같이 대부분의 프레임워크에서 이미 HMR을 사용할 수 있는 로더들을 지원하고 있지만,<br />
만약 개별적으로 설정하고 싶다면 다음과 같이 설정할 수 있다.<br />

```js
module.exports = {
  devServer: {
    hot: true,
  }
}
```

<br />

### Webpack Dev Server - 프록시(Proxy) 설정

```js
module.exports = {
  devServer: {
    proxy: {
      '/api': 'http://localhost:3000'
    }
  }
}
```

위와 같이 설정하면 local 웹팩데브서버에서 발생하는 API 요청에 변화가 생긴다.<br />

<img width="800" src="https://user-images.githubusercontent.com/19165916/201622801-9a2583bb-6a0b-4072-a3f9-00045a849da4.png" />

> 프록시를 쓰지 않았을 때의 기본적인 웹팩데브서버와 API 서버의 통신 구조.

여기서 [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)라는 용어가 나온다.<br />
이 용어는 '브라우저 보안'과 관계가 있는데, 쉽게 얘기하면 '다른 도메인 간'에는 '자바스크립트로 자원을 요청할 수 없다'는 의미이다. 그림에서도 서버에 로그인 관련 API 요청을 했는데, CORS 오류가 나는 걸 볼 수 있다.

뷰, 리액트와 같은 프런트엔드 프레임워크를 쓰면 개발 편의상 로컬에 웹팩 데브 서버를 띄워놓고 개발하는 경우가 많다.<br />
이 때, 이러한 문제를 해결하기 위해서 `proxy` 속성을 설정하면 서버에서 해당 요청을 받아준다.

```js
module.exports = {
  devServer: {
    proxy: {
      '/api': 'domain.com'
    }
  }
}
```

<img width="800" src="https://user-images.githubusercontent.com/19165916/201623669-aaea70f3-4265-4e17-a616-34dbf7599958.png" />

CORS가 브라우저 보안과 관련있기 때문에 브라우저에서 벗어나 '서버에서 서버로 요청'한다.<br />
실제로 브라우저에서는 `localhost:8080/api/login`으로 요청했지만, 중간에 프록시 서버로 인해 'domain.com 서버'에서는 '같은 도메인(domain.com)'에서 온 요청으로 인식해 CORS 에러가 나지 않는다.

```js
module.exports = {
  devServer: {
    proxy: {
      '/api': 'domain.com',
      changerOrigin: true,
    }
  }
}
```

<br />

## 웹팩 실행 모드 - mode

> v4부터 지원.

```js
module.exports = {
  mode: 'none',
  entry: '',
}
```


`mode`속성을 정의하면 웹팩의 실행 모드가 설정된다.<br />
웹팩의 실행 모드에는 다음 3가지가 있다.

- `none`: 모드 설정 안함
- `development`: 개발 모드
- `production`: 배포 모드

각 실행 모드에 따라 '웹팩의 결과물'이 달라진다. 개발 모드인 경우에는 개발자들이 좀 더 보기 편하게 웹팩 로그나 결과물이 보여지고, 배포 모드인 경우에는 성능 최적화를 위해 기본적인 파일 압축 등의 빌드 과정이 추가된다.

> 모드의 기본 값을 설정하지 않으면 `production` 모드로 자동 설정된다.

<br />

### 실행 모드에 따라 웹팩 설정하기

웹팩으로 실제 웹 앱을 개발할 때는 보통 아래와 같이 2가지 케이스로 구분하여 작업해야 한다.<br />

- 개발할 때 사용할 웹팩 설정
- 개발이 끝나고 배포할 때 사용할 웹팩 설정

웹팩 설정 파일이 1개인 상태에서 실행 모드에 따라 특정 설정을 적용하는 방법은 다음과 같다.

```js
// webpack.config.js
module.exports = (env) => {
  let entryPath = env.mode === 'production'
  ? './public/index.js'
  : './src/index.js';
  
  return {
    entry: entryPath,
    output: {},
    // ...
  }
```
```json
// package.json
{
  "build": "webpack",
  "development": "npm run build -- --env.development",
  "production": "npm run build -- --env.module=production"
}
```

위 코드를 보면 웹팩 설정 파일의 방식은 객체에서 함수로 바뀌었다.

```js
// 기존
module.exports = {};

// 현재
module.exports = () => {};
```

그리고 함수에서 받은 `env` 매개 변수는 '환경 변수'를 의미하며 웹팩을 실행할 때 실행 옵션으로 넘겨줄 수 있다.

```
webpack --env.a=10
```

만약 npm 커스텀 명령어로 고나리를 한다면 다음과 같이 할 수 있다.

```json
{
  "build": "webpack --env.a=10"
}
```

위와 같은 방식으로 실행 모드에 따라 웹팩의 설정을 각각 다르게 적용할 수 있다.

<br />

## Webpack Merge

웹팩 머지는 단어 그대로 여러 개의 웹팩 설정 파일을 하나로 병합해주는 라이브러리이다.<br />
일반적으로 웹앱을 제작할 때는 웹팩 설정을 개발용(development)과 배포용(production)으로 나누어 적용한다.

<br />

### 웹팩 설정 파일 구분 전략

웹팩 머지를 효율적으로 사용하는 방법은 개발용과 배포용 설정 파일에서 공통으로 쓰이는 부분을 먼저 불리하는 것이다.<br />
파일은 아래와 같은 형식으로 구성한다.

```
webpack.common.js
webpack.dev.js
webpack.prod.js
```

각 파일의 모습은 다음과 같다.

```js
// webpack.common.js
module.exports = {
  entry: './src/index.js',
  output: {
    filename: 'bundle.js',
  },
  plugins: [
    new CleanWebpackPlugin(),
    new HtmlWebpackPlugin(),
  ],
}
```

> 공통 설정 파일에는 엔트리, 아웃풋, 플러그인과 같이 실행 모드에 관계 없이 항상 들어가야 하는 코드를 추가한다.

<br />

```js
// webpack.config.js
const merge = rquire('webpack-merge');
const common = require('./webpack.common.js');

module.exports = merge(common, {
  mode: 'development',
  devtool: 'inline-source-map',
  devServer: { contentBase: './dist' },
});
```

> 개발용 설정 파일에는 개발자 도구나 웹팩데브서버와 같은 설정을 추가한다.<br />
> 그리고 `webpack-merge`라이브러리를 설치 및 로드하고 공통설정파일인 `webpack.config.js`와 병합해준다.

<br />

```js
// webpack.prod.js
const merge = require('webpack-merge');
const common = require('./webpack.common.js');

module.exports = merge(common, {
  mode: 'production',
})
```

> 배포용 설정 파일에는 배포하기 전, 웹 리소스 최적화를 위한 설정들을 추가해준다.

<br />

### 참고 자료 - Webpack Merge

- [webpack-merge 깃헛 리파지토리](https://github.com/survivejs/webpack-merge)
- [배포를 위한 웹팩 설정 가이드](https://webpack.js.org/guides/production/)




